$f:\mathbb{R^{n}} \to \mathbb{R^{n}},\ x \mapsto f(x)$のとき,
$\frac{\mathrm{\partial}f(x)}{\mathrm{\partial}x}|_{x=a}$を,$f(a)=b$という条件だけで求めることはできない.
したがって,もしtorch.tensorで$a \mapsto f(a)$の間でグラフが切断されるなら,
$\frac{\mathrm{\partial}f(x)}{\mathrm{\partial}x}|_{x=a}$を情報として渡してあげればよい.
以下,cudaを部分的に利用したり,並列処理に向いていない処理をcpuで処理させるために切断される関数についての偏微分を示す.

ガウス分布の不透明度$o$,放射輝度$l$,ガウス分布の平均$m$,ガウス分布の精度行列$Σ^{-1}$を入力として,
レンダリング画像$I$を出力する処理をpytorchの自動微分機能で実装すると,
中間テンソルとして現れるピクセル値テンソルがメモリ容量の観点から問題になる.
なぜなら,ガウス点群は一般に数百万であり,それにたいしてシーン画像は1920×1080や5600×3200となるから,
ピクセル値を算出するテンソルは小さく見積もっても数百万×数千万×数バイト(単精度浮動小数点数なら4バイト)となり,
一般的なgpuのメモリ容量数GB≒10^9[バイト]では圧倒的に不足することになる.
たしかにtorchは、勾配計算時に再計算可能なら中間テンソルやそのヤコビアン行列をキャッシュするのではなく、計算式をキャッシュすることでメモリ容量を節約する機能がある。
しかしそれは、すべてのテンソル計算についてあるわけではなく,torch.mulなどの一部のメソッドに限られている.
よって,ピクセル値算出は自分で勾配計算する方法を取らざるを得ない.
以下では,ピクセル値算出とその勾配計算の方法について述べる.

### ピクセル値算出
ガウス分布$i$の$99.7$％を占める長方形$S_i$の左上点から右下点までのピクセル座標$(u,v)$を
行方向にならべたテンソルを$r^i \in \mathbb{R}^{s_i \times 2}$とする.ここで$s_i$は$S_i$に含まれるピクセル点の総数であり,
$r^i$は$s_i$が行数,列数2の行列であることを意味する.
これを全てのガウス分布$i$について行方向につなげたテンソルを$r \in \mathbb{R}^{\left(\sum_i s_i \times 2\right)}$とする.
ガウス分布の不透明度$o$,放射輝度$l$,ガウス分布の平均$m$,ガウス分布の精度行列$Σ^{-1} = \Lambda$はそれぞれ,
ガウス分布の数をnとするとき,$o\in \mathbb{R}^{n \times 1}$,$l\in \mathbb{R}^{n \times 3}$,$m\in \mathbb{R}^{n \times 2}$,$\Lambda\in \mathbb{R}^{n \times 2 \times 2}$のテンソルである.
$\Lambda\in \mathbb{R}^{n \times 2 \times 2}$は,2×2の行列をガウス分布の数nだけ並べたものだと考えてほしい.
ここで上記のパラメータをガウス分布の99.7%ボックスごとにコピーしたテンソルを作る.
例えば,
$$
f_o:\mathbb{R}^{n \times 1} \to \mathbb{R}^{(\sum_{i}s_i\times 1)}, o \mapsto o_{copy} \tag{1}
$$
である.ここで,ガウス$i$に属する不透明度は$o$テンソルの$i$行1列成分であるので,それを$o(i,1)$と表すと,
$m = 1,2,3,..,s_iに対して$
$$
o_{copy}\left(\sum_{k \lt i} s_k +m,\ 1\right) = o(i,1) \tag{2}
$$
が成り立つということである.
同様に放射輝度,平均、精度行列についても以下のようにコピーテンソルを作る.
$$
f_l:\mathbb{R}^{n \times 3} \to \mathbb{R}^{(\sum_{i}s_i\times 3)}, l \mapsto l_{copy} \tag{3}
$$
$$
f_m:\mathbb{R}^{n \times 2} \to \mathbb{R}^{(\sum_{i}s_i\times 2)}, m \mapsto m_{copy} \tag{4}
$$
$$
f_{\Lambda}:\mathbb{R}^{n \times 2 \times 2} \to \mathbb{R}^{(\sum_{i}s_i\times 2 \times 2)}, \Lambda \mapsto \Lambda_{copy} \tag{5}
$$
精度行列は下付き文字の煩雑さのため,$\Lambda$を用いた.
光は深度が小さい順に物体を透過していくので、その光の減衰を考慮しなければならない.
ここで$o,l,m,\Lambda$はそれぞれzソートつまり深度が小さい順に与えられていると仮定すると,
アルファブレンド$T \in \mathbb{R}^{(\sum_{i}s_i\times 1)}$は以下のように与えられる.

$$
T(i,1) = \prod_{k \lt i} \left( 1-\sigma(i,k) o_{copy}(k,1)g(k,1) \right) \tag{6}
$$
ただし,$\sigma\in \mathbb{R}^{(\sum_{i}s_i\times \sum_{i}s_i)}$テンソルは以下のように定義される.
$$
\sigma(i,k) = \begin{cases}
    1 & \left\{ r(i,:) = r(k,:) \right\} \\
    0 & \left\{ r(i,:) ≠ r(k,:) \right\}
    \end{cases} \tag{7}
$$
ここで$r(i,:)$は,$i$行ベクトル$r_i$を表す.
また,$g\in\mathbb{R}^{(\sum_{i}s_i\times 1)}$はガウスカーネルで以下のように与えられる.
$$
g = \exp{\left\{-0.5(r-m_{copy})\Lambda_{copy} (r-m_{copy})^T \right\}} \tag{8}
$$
ピクセル位置$r$はガウス分布から$|r-m|$だけ離れているので,その影響をアルファブレンドに加えているわけです.

ピクセル座標$r$のピクセル値$p\in \mathbb{R}^{(\sum_{i}s_i\times 3)}$は,以下のようにして求められる.
$$
p = T\cdot l_{copy} \cdot o_{copy} \cdot g \tag{9}
$$
ここで,「$\cdot$」はアダマール積つまり成分ごとの積を表す.
これをピクセル座標ごとに合計することで画像テンソル$I \in \mathbb{R}^{(height \times width \times 3)}$が得られる.
widthは画像の幅,heightは画像の高さである.
### 勾配計算
実装したい計算は,損失関数$L$における画像テンソル$I$の勾配$\frac{∂L}{∂I}$から,パラメータ$o,l,m,\Lambda$の勾配
$\frac{∂L}{∂o},\frac{∂L}{∂l},\frac{∂L}{∂m},\frac{∂L}{∂\Lambda}$を計算することである.
順に計算していく.まず$\frac{∂L}{∂o}$は,
$$
\frac{∂L}{∂o} = \frac{∂L}{∂I}\cdot \frac{∂I}{∂p} \cdot \frac{∂p}{∂o} = \frac{∂L}{∂I}\cdot \frac{∂I}{∂p}\left ( \frac{∂p}{∂T} \cdot \frac{∂T}{∂o} + \frac{∂p}{∂o_{copy}} \cdot \frac{∂o_{copy}}{∂o} \right) \tag{10}
$$
となる.ただし,ここでの「$\cdot$」はテンソルに対する行列積あるいは単に行列積である.$\frac{∂L}{∂I}\cdot\frac{∂I}{∂p}$は定義から,
$$
\left[\frac{∂L}{∂I}\cdot \frac{∂I}{∂p}\right](i,:) = \frac{∂L}{∂I}\left(r(i,2),r(i,1),:\right)  \tag{11}
$$

$$
\left[\frac{∂L}{∂p} \cdot \frac{∂p}{∂o_{copy}} \cdot \frac{∂o_{copy}}{∂o}\right](i,1) = \sum_{k=1}^{s_i}\frac{∂L}{∂p}\left(S_{i-1} + k,\ :\right)\left[T\cdot l_{copy} \cdot g\right]^T(S_{i-1}+k,\ :) \tag{12}
$$
ただし,
$$
S_i = \sum_{m=1}^{i}s_m \tag{13}
$$
$$
\left[\frac{∂L}{∂p} \cdot \frac{∂p}{∂T} \cdot \frac{∂T}{∂o}\right](i,1) = \sum_{m=S_{i-1}+1}^{S_{i}} \sum_{k \geqq m} \frac{∂L}{∂p}\left(k,\ :\right)\left\{-\frac{\sigma(m,k) \cdot g(k,1)}{1-o_{copy}(k,1)\cdot g(k,1)}\cdot p(k,:)\right\}^T \tag{14}
$$
次に$\frac{∂L}{∂l}$を求める.
$$
\frac{∂L}{∂l} = \frac{∂L}{∂p} \cdot \frac{∂p}{∂l}
$$
$$
\frac{∂l}{∂l}(i,:) = \sum_{k=1}^{s_i}\frac{∂L}{∂p}\left(S_{i-1} + i,\ :\right)\left[T\cdot o_{copy} \cdot g\right](S_{i-1}+1,\ :)I
$$
ここで,$I$は$3\times 3$の単位行列である.
次に$\frac{∂L}{∂m}$を求める.

$$
\frac{∂L}{∂m} = \frac{∂L}{∂p} \cdot \frac{∂p}{∂m} = \frac{∂L}{∂p}\left ( \frac{∂p}{∂T} \cdot \frac{∂T}{∂g}\cdot \frac{∂g}{∂m_{copy}}\cdot \frac{∂m_{copy}}{∂m} + \frac{∂p}{∂g} \cdot \frac{∂g}{∂m_{copy}}\cdot \frac{∂m_{copy}}{∂m} \right) \tag{}
$$

ここで,行列積の積の微分法を用いると,
$$
\frac{∂g(i,:)}{∂m_{copy}(i,:)} = \frac{∂}{∂m_{copy}}\left[\exp{\left\{-0.5(r-m_{copy})\Lambda_{copy} (r-m_{copy})^T \right\}}\right] 
$$
$$
= 0.5g \cdot \left\{ (r-m_{copy}) \Lambda_{copy}^T + (r-m_{copy})\Lambda_{copy} \right \} = g(i,:)\cdot\left\{r(i,:)-m_{copy}(i,:)\right\}\Lambda_{copy}(i,:,:)
$$
右辺の添え字(i,:)は省略した.
$\Lambda_{copy}$は対称行列の逆行列であるから対称行列であることを用いた.
よって,
$$
\left[\frac{∂L}{∂p} \cdot \frac{∂p}{∂g} \cdot \frac{∂g}{∂m_{copy}}\cdot \frac{∂m_{copy}}{∂m}\right](i,:)= \sum_{k=S_{i-1}+1}^{S_i}\frac{∂L}{∂p}\left(k,\ :\right)\left[T\cdot l_{copy} \cdot o_{copy} \cdot g\right]^T(k,\ :)\left\{r(k,:)-m_{copy}(k,:)\right\}\Lambda_{copy}(k,:,:)
$$
$$
= \sum_{k=S_{i-1}+1}^{S_i}\frac{∂L}{∂p}\left(k,\ :\right)p^T(k,\ :)\left\{r(k,:)-m_{copy}(k,:)\right\}\Lambda_{copy}(k,:,:)
$$
同様に,
$$
\left[\frac{∂L}{∂p} \cdot \frac{∂p}{∂T} \cdot \frac{∂T}{∂m}\right](i,1) = \sum_{m=S_{i-1}+1}^{S_{i}} \sum_{k \geqq m} \frac{∂L}{∂p}\left(k,\ :\right)\left\{-\frac{\sigma(m,k) \cdot o_{copy}(k,1) \cdot g(k,1)}{1-o_{copy}(k,1)\cdot g(k,1)}\cdot p(k,:)\right\}^T\left\{r(k,:)-m_{copy}(k,:)\right\}\Lambda_{copy}(k,:,:)
$$
次に$\frac{∂L}{∂\Lambda}$を求める.
$$
\frac{∂g(i,:)}{∂\Lambda_{copy}(i,:,:)} = -0.5g\cdot (r-m_{copy})(r-m_{copy})^T
$$
$$
\left[\frac{∂L}{∂p} \cdot \frac{∂p}{∂g} \cdot \frac{∂g}{∂\Lambda_{copy}}\cdot \frac{∂\Lambda_{copy}}{∂\Lambda}\right](i,:)= \sum_{k=S_{i-1}+1}^{S_i}\frac{∂L}{∂p}\left(k,\ :\right)\left[T\cdot l_{copy} \cdot o_{copy} \cdot -g\right]^T(k,\ :)\left\{r(k,:)-m_{copy}(k,:)\right\}\Lambda(k,:,:)
$$